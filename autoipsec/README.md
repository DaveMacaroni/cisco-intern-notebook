# Using Ansible to automate tunnel setup
The goal of this task was to automate the process of creating a tunnel in Umbrella, sending that information to an SSH ready VM, and having all the traffic destined for the internet go through said tunnel.

### Automating tunnel creation
The first thing I did was create a python bot *prepare.py* that opens a browser and creates a tunnel in Umbrella. 
The files that complete this task are named: *prepare.py* *addtunnel.py* *umbrellalogin.py* and *local* (which is located under **group_vars**). 
*prepare.py* writes the required information to configure a tunnel into *local* and is used by *ipsec.conf.j2* and *ipsec.secrets.j2* later.

### Setting up an SSH ready VM
The next step was to prepare a VM that was bare-bones ready for Ansible, so the first thing to do was set up a new Linux VM and install ssh with command ```sudo apt-get install ssh```. Next was to copy over my public key generated by the Mac located at ```~/.ssh/id_rsa.pub``` into a file on the VM located at ```~/.ssh/authorized_keys```. Then ```sudo reboot``` for the changes to take place.<br/>

That wasn't enough because later I ran into a similar problem as I had previously on the *Ansible-Jun29.md* file, but this was easily fixed. The VM was then screenshotted in this current state so when I was experimenting and trying to get it to work properly, I wouldn't have to recreate the VM everytime in order for it to get ready again. Screenshots saved me an undescribable amount of time.

### IPSec setup
Next was to make sure that the ipsec configuration files were in the right place for Ansible to find them. In this case, templates were used and put under ```roles/copy/templates```. *ipsec.conf.j2* and *ipsec.secrets.j2* were placed there. It's important to note that j2 files are used because that is what Ansible looks for when using templates.<br/>

Now that that was complete, it was time for the VTI and VETH setup.

### Virtual Tunnel Interface and Virtuale ETHernet setup
Under ```roles/vtisetup/files``` contains the *vtisetup* bash script that creates said tunnel. This creates an interface for the tunnel and allows traffic to exit the VM through it rather than the Bridged Adapter linked to the mac host.<br/>

Under ```roles/vethsetup/files``` contains the *vethsetup* bash script that creates a client namespace that routes all traffic through a virtual ethernet to the VM which then puts it through the tunnel.<br/>

The reason the VETH pair had to be setup was because you can't route traffic throught a dummy interface because the dummy routes packets without actually transmitting them. So in order to actually send data through the tunnel you would've had to specify that the interface is where you want to source from, but the goal was to just by default send all traffic destined for the internet through to the Umbrella DC and then to the internet. 
So what the VETH pair does is it creates a client namespace in which you log into, and then start browsing the internet. Now all traffic goes through the tunnel to the Umbrella DC, then it goes to the internet.

### How to use
So to use this make sure the VM is properly configured as well as all the configuration files such as: *umbrellalogin.py*, *addtunnel.py*, *inventory*, and the files in ```roles/copy/files```. Then run ```python3 prepare.py``` and let the Umbrella bot create the tunnel. After that run ```ansible-playbook setup.yml``` and it will install everything where it needs to be and start the tunnel when everything is done. All that's left is to enter the name space by typing ```sudo ip netns exe client bash``` where client is the name given in the VETH setup. Now run a traceroute and see that traffic first goes through Umbrella DC's before reaching the internet.
